#!/bin/bash

set -e

function usage {
    cat <<EOF >&2 
Usage: run-borg <volume> [ <borg-arg> ... ]
    Configuration for <volume> must exist.
EOF
    exit 1
}

# load config
MY_DIR=$(dirname $(dirname $(realpath "$0")))
MY_CONFIG="${MY_DIR}/etc/backup.conf"
if [ ! -r "${MY_CONFIG}" ]; then
    echo "ERROR: configuration file '${MY_CONFIG}' missing" >&2
    exit 1
fi
. "${MY_CONFIG}"
# BACKUP_SERVER
# BACKUP_SSHKEY
# BACKUP_CONNECT_WINDOW


# parse arguments
BACKUP_VOLUME="$1"
[ -z "${BACKUP_VOLUME}" ] && usage
shift

BORG_ARGS="$@"


CLIENT_CONFIG_DIR="${MY_DIR}/${BACKUP_VOLUME}"
if [ ! -r "${CLIENT_CONFIG_DIR}/config" ]; then
    echo "ERROR: client configuration in '${CLIENT_CONFIG_DIR}' missing" >&2
    exit 1
fi

source "${CLIENT_CONFIG_DIR}/config"
# BACKUP_CLIENT
# BACKUP_PORT
# BACKUP_USER
# BACKUP_SET
# BACKUP_REPO
# BORG_PASSPHRASE (optional)

if [ ! -d "${BACKUP_REPO}" ]; then
    echo "ERROR: repository '${BACKUP_REPO}' missing" >&2
    exit 1
fi

eval $(ssh-agent -s -t "$BACKUP_CONNECT_WINDOW") >/dev/null
cleanup () { eval $(ssh-agent -k) >/dev/null ; }
trap cleanup SIGINT SIGTERM EXIT
ssh-add "${CLIENT_CONFIG_DIR}/id_rsa" 2>/dev/null

export BORG_PASSPHRASE
ssh -o SendEnv='BORG_PASSPHRASE' -o StrictHostKeyChecking='accept-new' \
  -i "${BACKUP_SSHKEY}" -A \
  -p "${BACKUP_PORT}" "root@${BACKUP_CLIENT}" \
"borg ${BORG_ARGS} \
  '${BACKUP_USER}@${BACKUP_SERVER}:${BACKUP_REPO}'"

